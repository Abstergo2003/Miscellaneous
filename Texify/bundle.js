!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).exprEval={})}(this,(function(t){"use strict";var e="INUMBER",r="IOP1",s="IOP2",n="IOP3",i="IVAR",o="IVARNAME",a="IFUNCALL",p="IFUNDEF",h="IEXPR",u="IEXPREVAL",c="IMEMBER",l="IENDSTATEMENT",f="IARRAY";function v(t,e){this.type=t,this.value=null!=e?e:0}function y(t){return new v(r,t)}function E(t){return new v(s,t)}function x(t){return new v(n,t)}function A(t,a,p,u,l){for(var y,E,x,M,T=[],w=[],g=0;g<t.length;g++){var d=t[g],m=d.type;if(m===e||m===o)Array.isArray(d.value)?T.push.apply(T,A(d.value.map((function(t){return new v(e,t)})).concat(new v(f,d.value.length)),a,p,u,l)):T.push(d);else if(m===i&&l.hasOwnProperty(d.value))d=new v(e,l[d.value]),T.push(d);else if(m===s&&T.length>1)E=T.pop(),y=T.pop(),M=p[d.value],d=new v(e,M(y.value,E.value)),T.push(d);else if(m===n&&T.length>2)x=T.pop(),E=T.pop(),y=T.pop(),"?"===d.value?T.push(y.value?E.value:x.value):(M=u[d.value],d=new v(e,M(y.value,E.value,x.value)),T.push(d));else if(m===r&&T.length>0)y=T.pop(),M=a[d.value],d=new v(e,M(y.value)),T.push(d);else if(m===h){for(;T.length>0;)w.push(T.shift());w.push(new v(h,A(d.value,a,p,u,l)))}else if(m===c&&T.length>0)y=T.pop(),T.push(new v(e,y.value[d.value]));else{for(;T.length>0;)w.push(T.shift());w.push(d)}}for(;T.length>0;)w.push(T.shift());return w}function M(t,e,o){for(var a=[],p=0;p<t.length;p++){var u=t[p],c=u.type;if(c===i&&u.value===e)for(var l=0;l<o.tokens.length;l++){var f,A=o.tokens[l];f=A.type===r?y(A.value):A.type===s?E(A.value):A.type===n?x(A.value):new v(A.type,A.value),a.push(f)}else c===h?a.push(new v(h,M(u.value,e,o))):a.push(u)}return a}function T(t,v,y){var E,x,A,M,m,O,I=[];if(g(t))return d(t,y);for(var b=t.length,k=0;k<b;k++){var P=t[k],R=P.type;if(R===e||R===o)I.push(P.value);else if(R===s)x=I.pop(),E=I.pop(),"and"===P.value?I.push(!!E&&!!T(x,v,y)):"or"===P.value?I.push(!!E||!!T(x,v,y)):"="===P.value?(M=v.binaryOps[P.value],I.push(M(E,T(x,v,y),y))):(M=v.binaryOps[P.value],I.push(M(d(E,y),d(x,y))));else if(R===n)A=I.pop(),x=I.pop(),E=I.pop(),"?"===P.value?I.push(T(E?x:A,v,y)):(M=v.ternaryOps[P.value],I.push(M(d(E,y),d(x,y),d(A,y))));else if(R===i)if(P.value in v.functions)I.push(v.functions[P.value]);else if(P.value in v.unaryOps&&v.parser.isOperatorEnabled(P.value))I.push(v.unaryOps[P.value]);else{var N=y[P.value];if(void 0===N)throw new Error("undefined variable: "+P.value);I.push(N)}else if(R===r)E=I.pop(),M=v.unaryOps[P.value],I.push(M(d(E,y)));else if(R===a){for(O=P.value,m=[];O-- >0;)m.unshift(d(I.pop(),y));if(!(M=I.pop()).apply||!M.call)throw new Error(M+" is not a function");I.push(M.apply(void 0,m))}else if(R===p)I.push(function(){for(var t=I.pop(),e=[],r=P.value;r-- >0;)e.unshift(I.pop());var s=I.pop(),n=function(){for(var r=Object.assign({},y),s=0,n=e.length;s<n;s++)r[e[s]]=arguments[s];return T(t,v,r)};return Object.defineProperty(n,"name",{value:s,writable:!1}),y[s]=n,n}());else if(R===h)I.push(w(P,v));else if(R===u)I.push(P);else if(R===c)E=I.pop(),I.push(E[P.value]);else if(R===l)I.pop();else{if(R!==f)throw new Error("invalid Expression");for(O=P.value,m=[];O-- >0;)m.unshift(I.pop());I.push(m)}}if(I.length>1)throw new Error("invalid Expression (parity)");return 0===I[0]?0:d(I[0],y)}function w(t,e,r){return g(t)?t:{type:u,value:function(r){return T(t.value,e,r)}}}function g(t){return t&&t.type===u}function d(t,e){return g(t)?t.value(e):t}function m(t,u){for(var v,y,E,x,A,M,T=[],w=0;w<t.length;w++){var g=t[w],d=g.type;if(d===e)"number"==typeof g.value&&g.value<0?T.push("("+g.value+")"):Array.isArray(g.value)?T.push("["+g.value.map(O).join(", ")+"]"):T.push(O(g.value));else if(d===s)y=T.pop(),v=T.pop(),x=g.value,u?"^"===x?T.push("Math.pow("+v+", "+y+")"):"and"===x?T.push("(!!"+v+" && !!"+y+")"):"or"===x?T.push("(!!"+v+" || !!"+y+")"):"||"===x?T.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+v+"),("+y+")))"):"=="===x?T.push("("+v+" === "+y+")"):"!="===x?T.push("("+v+" !== "+y+")"):"["===x?T.push(v+"[("+y+") | 0]"):T.push("("+v+" "+x+" "+y+")"):"["===x?T.push(v+"["+y+"]"):T.push("("+v+" "+x+" "+y+")");else if(d===n){if(E=T.pop(),y=T.pop(),v=T.pop(),"?"!==(x=g.value))throw new Error("invalid Expression");T.push("("+v+" ? "+y+" : "+E+")")}else if(d===i||d===o)T.push(g.value);else if(d===r)v=T.pop(),"-"===(x=g.value)||"+"===x?T.push("("+x+v+")"):u?"not"===x?T.push("(!"+v+")"):"!"===x?T.push("fac("+v+")"):T.push(x+"("+v+")"):"!"===x?T.push("("+v+"!)"):T.push("("+x+" "+v+")");else if(d===a){for(M=g.value,A=[];M-- >0;)A.unshift(T.pop());x=T.pop(),T.push(x+"("+A.join(", ")+")")}else if(d===p){for(y=T.pop(),M=g.value,A=[];M-- >0;)A.unshift(T.pop());v=T.pop(),u?T.push("("+v+" = function("+A.join(", ")+") { return "+y+" })"):T.push("("+v+"("+A.join(", ")+") = "+y+")")}else if(d===c)v=T.pop(),T.push(v+"."+g.value);else if(d===f){for(M=g.value,A=[];M-- >0;)A.unshift(T.pop());T.push("["+A.join(", ")+"]")}else if(d===h)T.push("("+m(g.value,u)+")");else if(d!==l)throw new Error("invalid Expression")}return T.length>1&&(T=u?[T.join(",")]:[T.join(";")]),String(T[0])}function O(t){return"string"==typeof t?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function I(t,e){for(var r=0;r<t.length;r++)if(t[r]===e)return!0;return!1}function b(t,e,r){for(var s=!!(r=r||{}).withMembers,n=null,a=0;a<t.length;a++){var p=t[a];p.type===i||p.type===o?s||I(e,p.value)?null!==n?(I(e,n)||e.push(n),n=p.value):n=p.value:e.push(p.value):p.type===c&&s&&null!==n?n+="."+p.value:p.type===h?b(p.value,e,r):null!==n&&(I(e,n)||e.push(n),n=null)}null===n||I(e,n)||e.push(n)}function k(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}v.prototype.toString=function(){switch(this.type){case e:case r:case s:case n:case i:case o:case l:return this.value;case a:return"CALL "+this.value;case p:return"DEF "+this.value;case f:return"ARRAY "+this.value;case c:return"."+this.value;default:return"Invalid Instruction"}},k.prototype.simplify=function(t){return t=t||{},new k(A(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)},k.prototype.substitute=function(t,e){return e instanceof k||(e=this.parser.parse(String(e))),new k(M(this.tokens,t,e),this.parser)},k.prototype.evaluate=function(t){return t=t||{},T(this.tokens,this,t)},k.prototype.toString=function(){return m(this.tokens,!1)},k.prototype.symbols=function(t){t=t||{};var e=[];return b(this.tokens,e,t),e},k.prototype.variables=function(t){t=t||{};var e=[];b(this.tokens,e,t);var r=this.functions;return e.filter((function(t){return!(t in r)}))},k.prototype.toJSFunction=function(t,e){var r=this,s=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+m(this.simplify(e).tokens,!0)+"; }");return function(){return s.apply(r,arguments)}};var P="TEOF",R="TOP",N="TNUMBER",S="TSTRING",C="TPAREN",F="TBRACKET",L="TCOMMA",U="TNAME",B="TSEMICOLON";function V(t,e,r){this.type=t,this.value=e,this.index=r}function _(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}V.prototype.toString=function(){return this.type+": "+this.value},_.prototype.newToken=function(t,e,r){return new V(t,e,null!=r?r:this.pos)},_.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current},_.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent},_.prototype.next=function(){return this.pos>=this.expression.length?this.newToken(P,"EOF"):this.isWhitespace()||this.isComment()?this.next():this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},_.prototype.isString=function(){var t=!1,e=this.pos,r=this.expression.charAt(e);if("'"===r||'"'===r)for(var s=this.expression.indexOf(r,e+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,"\\"!==this.expression.charAt(s-1)){var n=this.expression.substring(e+1,s);this.current=this.newToken(S,this.unescape(n),e),t=!0;break}s=this.expression.indexOf(r,s+1)}return t},_.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return("("===t||")"===t)&&(this.current=this.newToken(C,t),this.pos++,!0)},_.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return!("["!==t&&"]"!==t||!this.isOperatorEnabled("["))&&(this.current=this.newToken(F,t),this.pos++,!0)},_.prototype.isComma=function(){return","===this.expression.charAt(this.pos)&&(this.current=this.newToken(L,","),this.pos++,!0)},_.prototype.isSemicolon=function(){return";"===this.expression.charAt(this.pos)&&(this.current=this.newToken(B,";"),this.pos++,!0)},_.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&"."!==r&&(r<"0"||r>"9")))break}if(e>t){var s=this.expression.substring(t,e);if(s in this.consts)return this.current=this.newToken(N,this.consts[s]),this.pos+=s.length,!0}return!1},_.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&(r<"0"||r>"9")))break}if(e>t){var s=this.expression.substring(t,e);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(R,s),this.pos+=s.length,!0}return!1},_.prototype.isName=function(){for(var t=this.pos,e=t,r=!1;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()){if(e===this.pos&&("$"===s||"_"===s)){"_"===s&&(r=!0);continue}if(e===this.pos||!r||"_"!==s&&(s<"0"||s>"9"))break}else r=!0}if(r){var n=this.expression.substring(t,e);return this.current=this.newToken(U,n),this.pos+=n.length,!0}return!1},_.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);!(" "!==e&&"\t"!==e&&"\n"!==e&&"\r"!==e||(t=!0,this.pos++,this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var j=/^[0-9a-f]{4}$/i;function q(t,e,r){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=!1!==r.allowMemberAccess}_.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var r=t.substring(0,e);e>=0;){var s=t.charAt(++e);switch(s){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+="\n";break;case"r":r+="\r";break;case"t":r+="\t";break;case"u":var n=t.substring(e+1,e+5);j.test(n)||this.parseError("Illegal escape sequence: \\u"+n),r+=String.fromCharCode(parseInt(n,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++e;var i=t.indexOf("\\",e);r+=t.substring(e,i<0?t.length:i),e=i}return r},_.prototype.isComment=function(){return"/"===this.expression.charAt(this.pos)&&"*"===this.expression.charAt(this.pos+1)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)},_.prototype.isRadixInteger=function(){var t,e,r=this.pos;if(r>=this.expression.length-2||"0"!==this.expression.charAt(r))return!1;if(++r,"x"===this.expression.charAt(r))t=16,e=/^[0-9a-f]$/i,++r;else{if("b"!==this.expression.charAt(r))return!1;t=2,e=/^[01]$/i,++r}for(var s=!1,n=r;r<this.expression.length;){var i=this.expression.charAt(r);if(!e.test(i))break;r++,s=!0}return s&&(this.current=this.newToken(N,parseInt(this.expression.substring(n,r),t)),this.pos=r),s},_.prototype.isNumber=function(){for(var t,e=!1,r=this.pos,s=r,n=r,i=!1,o=!1;r<this.expression.length&&((t=this.expression.charAt(r))>="0"&&t<="9"||!i&&"."===t);)"."===t?i=!0:o=!0,r++,e=o;if(e&&(n=r),"e"===t||"E"===t){r++;for(var a=!0,p=!1;r<this.expression.length;){if(t=this.expression.charAt(r),!a||"+"!==t&&"-"!==t){if(!(t>="0"&&t<="9"))break;p=!0,a=!1}else a=!1;r++}p||(r=n)}return e?(this.current=this.newToken(N,parseFloat(this.expression.substring(s,r))),this.pos=r):this.pos=n,e},_.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if("+"===e||"-"===e||"*"===e||"/"===e||"%"===e||"^"===e||"?"===e||":"===e||"."===e)this.current=this.newToken(R,e);else if("∙"===e||"•"===e)this.current=this.newToken(R,"*");else if(">"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(R,">="),this.pos++):this.current=this.newToken(R,">");else if("<"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(R,"<="),this.pos++):this.current=this.newToken(R,"<");else if("|"===e){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(R,"||"),this.pos++}else if("="===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(R,"=="),this.pos++):this.current=this.newToken(R,e);else{if("!"!==e)return!1;"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(R,"!="),this.pos++):this.current=this.newToken(R,e)}return this.pos++,!!this.isOperatorEnabled(this.current.value)||(this.pos=t,!1)},_.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)},_.prototype.getCoordinates=function(){var t,e=0,r=-1;do{e++,t=this.pos-r,r=this.expression.indexOf("\n",r+1)}while(r>=0&&r<this.pos);return{line:e,column:t}},_.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)},q.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},q.prototype.tokenMatches=function(t,e){return void 0===e||(Array.isArray(e)?I(e,t.value):"function"==typeof e?e(t):t.value===e)},q.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},q.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},q.prototype.accept=function(t,e){return!(this.nextToken.type!==t||!this.tokenMatches(this.nextToken,e))&&(this.next(),!0)},q.prototype.expect=function(t,e){if(!this.accept(t,e)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(e||t))}},q.prototype.parseAtom=function(t){var r=this.tokens.unaryOps;if(this.accept(U)||this.accept(R,(function(t){return t.value in r})))t.push(new v(i,this.current.value));else if(this.accept(N))t.push(new v(e,this.current.value));else if(this.accept(S))t.push(new v(e,this.current.value));else if(this.accept(C,"("))this.parseExpression(t),this.expect(C,")");else{if(!this.accept(F,"["))throw new Error("unexpected "+this.nextToken);if(this.accept(F,"]"))t.push(new v(f,0));else{var s=this.parseArrayList(t);t.push(new v(f,s))}}},q.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),this.parseUntilEndStatement(t,e)||this.pushExpression(t,e))},q.prototype.pushExpression=function(t,e){for(var r=0,s=e.length;r<s;r++)t.push(e[r])},q.prototype.parseUntilEndStatement=function(t,e){return!!this.accept(B)&&(!this.nextToken||this.nextToken.type===P||this.nextToken.type===C&&")"===this.nextToken.value||e.push(new v(l)),this.nextToken.type!==P&&this.parseExpression(e),t.push(new v(h,e)),!0)},q.prototype.parseArrayList=function(t){for(var e=0;!this.accept(F,"]");)for(this.parseExpression(t),++e;this.accept(L);)this.parseExpression(t),++e;return e},q.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(R,"=");){var e=t.pop(),r=[],s=t.length-1;if(e.type!==a){if(e.type!==i&&e.type!==c)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),t.push(new v(o,e.value)),t.push(new v(h,r)),t.push(E("="))}else{if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var n=0,u=e.value+1;n<u;n++){var l=s-n;t[l].type===i&&(t[l]=new v(o,t[l].value))}this.parseVariableAssignmentExpression(r),t.push(new v(h,r)),t.push(new v(p,e.value))}}},q.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(R,"?");){var e=[],r=[];this.parseConditionalExpression(e),this.expect(R,":"),this.parseConditionalExpression(r),t.push(new v(h,e)),t.push(new v(h,r)),t.push(x("?"))}},q.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(R,"or");){var e=[];this.parseAndExpression(e),t.push(new v(h,e)),t.push(E("or"))}},q.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(R,"and");){var e=[];this.parseComparison(e),t.push(new v(h,e)),t.push(E("and"))}};var D=["==","!=","<","<=",">=",">","in"];q.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(R,D);){var e=this.current;this.parseAddSub(t),t.push(E(e.value))}};var X=["+","-","||"];q.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(R,X);){var e=this.current;this.parseTerm(t),t.push(E(e.value))}};var G=["*","/","%"];function Y(t,e){return Number(t)+Number(e)}function K(t,e){return t-e}function $(t,e){return t*e}function J(t,e){return t/e}function W(t,e){return t%e}function H(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function z(t,e){return t===e}function Q(t,e){return t!==e}function Z(t,e){return t>e}function tt(t,e){return t<e}function et(t,e){return t>=e}function rt(t,e){return t<=e}function st(t,e){return Boolean(t&&e)}function nt(t,e){return Boolean(t||e)}function it(t,e){return I(e,t)}function ot(t){return(Math.exp(t)-Math.exp(-t))/2}function at(t){return(Math.exp(t)+Math.exp(-t))/2}function pt(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function ht(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function ut(t){return Math.log(t+Math.sqrt(t*t-1))}function ct(t){return Math.log((1+t)/(1-t))/2}function lt(t){return Math.log(t)*Math.LOG10E}function ft(t){return-t}function vt(t){return!t}function yt(t){return t<0?Math.ceil(t):Math.floor(t)}function Et(t){return Math.random()*(t||1)}function xt(t){return Tt(t+1)}q.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(R,G);){var e=this.current;this.parseFactor(t),t.push(E(e.value))}},q.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;if(this.save(),this.accept(R,(function(t){return t.value in e}))){if("-"!==this.current.value&&"+"!==this.current.value){if(this.nextToken.type===C&&"("===this.nextToken.value)return this.restore(),void this.parseExponential(t);if(this.nextToken.type===B||this.nextToken.type===L||this.nextToken.type===P||this.nextToken.type===C&&")"===this.nextToken.value)return this.restore(),void this.parseAtom(t)}var r=this.current;this.parseFactor(t),t.push(y(r.value))}else this.parseExponential(t)},q.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(R,"^");)this.parseFactor(t),t.push(E("^"))},q.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(R,"!");)t.push(y("!"))},q.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;if(this.accept(R,(function(t){return t.value in e}))){var r=this.current;this.parseAtom(t),t.push(y(r.value))}else for(this.parseMemberExpression(t);this.accept(C,"(");)if(this.accept(C,")"))t.push(new v(a,0));else{var s=this.parseArgumentList(t);t.push(new v(a,s))}},q.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(C,")");)for(this.parseExpression(t),++e;this.accept(L);)this.parseExpression(t),++e;return e},q.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(R,".")||this.accept(F,"[");){var e=this.current;if("."===e.value){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(U),t.push(new v(c,this.current.value))}else{if("["!==e.value)throw new Error("unexpected symbol: "+e.value);if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(F,"]"),t.push(E("["))}}};var At=4.7421875,Mt=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Tt(t){var e,r;if(function(t){return isFinite(t)&&t===Math.round(t)}(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var s=t-2,n=t-1;s>1;)n*=s,s--;return 0===n&&(n=1),n}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Tt(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,o=i*t,a=o*t,p=a*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*o)-571/(2488320*a)+163879/(209018880*p)+5246819/(75246796800*p*t))}--t,r=Mt[0];for(var h=1;h<Mt.length;++h)r+=Mt[h]/(t+h);return e=t+At+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*r}function wt(t){return Array.isArray(t)?t.length:String(t).length}function gt(){for(var t=0,e=0,r=0;r<arguments.length;r++){var s,n=Math.abs(arguments[r]);e<n?(t=t*(s=e/n)*s+1,e=n):t+=n>0?(s=n/e)*s:n}return e===1/0?1/0:e*Math.sqrt(t)}function dt(t,e,r){return t?e:r}function mt(t,e){return void 0===e||0==+e?Math.round(t):(t=+t,e=-+e,isNaN(t)||"number"!=typeof e||e%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+e:e))))}function Ot(t,e,r){return r&&(r[t]=e),e}function It(t,e){return t[0|e]}function bt(t){return 1===arguments.length&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function kt(t){return 1===arguments.length&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Pt(t,e){if("function"!=typeof t)throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map((function(e,r){return t(e,r)}))}function Rt(t,e,r){if("function"!=typeof t)throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce((function(e,r,s){return t(e,r,s)}),e)}function Nt(t,e){if("function"!=typeof t)throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter((function(e,r){return t(e,r)}))}function St(t,e){if(!Array.isArray(e)&&"string"!=typeof e)throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function Ct(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Ft(t){return(t>0)-(t<0)||+t}var Lt=1/3;function Ut(t){return t<0?-Math.pow(-t,Lt):Math.pow(t,Lt)}function Bt(t){return Math.exp(t)-1}function Vt(t){return Math.log(1+t)}function _t(t){return Math.log(t)/Math.LN2}function jt(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||ot,cosh:Math.cosh||at,tanh:Math.tanh||pt,asinh:Math.asinh||ht,acosh:Math.acosh||ut,atanh:Math.atanh||ct,sqrt:Math.sqrt,cbrt:Math.cbrt||Ut,log:Math.log,log2:Math.log2||_t,ln:Math.log,lg:Math.log10||lt,log10:Math.log10||lt,expm1:Math.expm1||Bt,log1p:Math.log1p||Vt,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||yt,"-":ft,"+":Number,exp:Math.exp,not:vt,length:wt,"!":xt,sign:Math.sign||Ft},this.binaryOps={"+":Y,"-":K,"*":$,"/":J,"%":W,"^":Math.pow,"||":H,"==":z,"!=":Q,">":Z,"<":tt,">=":et,"<=":rt,and:st,or:nt,in:it,"=":Ot,"[":It},this.ternaryOps={"?":dt},this.functions={random:Et,fac:xt,min:kt,max:bt,hypot:Math.hypot||gt,pyt:Math.hypot||gt,pow:Math.pow,atan2:Math.atan2,if:dt,gamma:Tt,roundTo:mt,map:Pt,fold:Rt,filter:Nt,indexOf:St,join:Ct},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}jt.prototype.parse=function(t){var e=[],r=new q(this,new _(this,t),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(e),r.expect(P,"EOF"),new k(e,this)},jt.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var qt=new jt;jt.parse=function(t){return qt.parse(t)},jt.evaluate=function(t,e){return qt.parse(t).evaluate(e)};var Dt={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};jt.prototype.isOperatorEnabled=function(t){var e=function(t){return Dt.hasOwnProperty(t)?Dt[t]:t}(t),r=this.options.operators||{};return!(e in r)||!!r[e]};var Xt={Parser:jt,Expression:k};t.Expression=k,t.Parser=jt,t.default=Xt,Object.defineProperty(t,"__esModule",{value:!0})}));var INUMBER="INUMBER",IOP1="IOP1",IOP2="IOP2",IOP3="IOP3",IVAR="IVAR",IVARNAME="IVARNAME",IFUNCALL="IFUNCALL",IFUNDEF="IFUNDEF",IEXPR="IEXPR",IEXPREVAL="IEXPREVAL",IMEMBER="IMEMBER",IENDSTATEMENT="IENDSTATEMENT",IARRAY="IARRAY";function Instruction(t,e){this.type=t,this.value=null!=e?e:0}function unaryInstruction(t){return new Instruction(IOP1,t)}function binaryInstruction(t){return new Instruction(IOP2,t)}function ternaryInstruction(t){return new Instruction(IOP3,t)}function simplify(t,e,r,s,n){for(var i,o,a,p,h=[],u=[],c=0;c<t.length;c++){var l=t[c],f=l.type;if(f===INUMBER||f===IVARNAME)Array.isArray(l.value)?h.push.apply(h,simplify(l.value.map((function(t){return new Instruction(INUMBER,t)})).concat(new Instruction(IARRAY,l.value.length)),e,r,s,n)):h.push(l);else if(f===IVAR&&n.hasOwnProperty(l.value))l=new Instruction(INUMBER,n[l.value]),h.push(l);else if(f===IOP2&&h.length>1)o=h.pop(),i=h.pop(),p=r[l.value],l=new Instruction(INUMBER,p(i.value,o.value)),h.push(l);else if(f===IOP3&&h.length>2)a=h.pop(),o=h.pop(),i=h.pop(),"?"===l.value?h.push(i.value?o.value:a.value):(p=s[l.value],l=new Instruction(INUMBER,p(i.value,o.value,a.value)),h.push(l));else if(f===IOP1&&h.length>0)i=h.pop(),p=e[l.value],l=new Instruction(INUMBER,p(i.value)),h.push(l);else if(f===IEXPR){for(;h.length>0;)u.push(h.shift());u.push(new Instruction(IEXPR,simplify(l.value,e,r,s,n)))}else if(f===IMEMBER&&h.length>0)i=h.pop(),h.push(new Instruction(INUMBER,i.value[l.value]));else{for(;h.length>0;)u.push(h.shift());u.push(l)}}for(;h.length>0;)u.push(h.shift());return u}function substitute(t,e,r){for(var s=[],n=0;n<t.length;n++){var i=t[n],o=i.type;if(o===IVAR&&i.value===e)for(var a=0;a<r.tokens.length;a++){var p,h=r.tokens[a];p=h.type===IOP1?unaryInstruction(h.value):h.type===IOP2?binaryInstruction(h.value):h.type===IOP3?ternaryInstruction(h.value):new Instruction(h.type,h.value),s.push(p)}else o===IEXPR?s.push(new Instruction(IEXPR,substitute(i.value,e,r))):s.push(i)}return s}function evaluate(t,e,r){var s,n,i,o,a,p,h=[];if(isExpressionEvaluator(t))return resolveExpression(t,r);for(var u=t.length,c=0;c<u;c++){var l=t[c],f=l.type;if(f===INUMBER||f===IVARNAME)h.push(l.value);else if(f===IOP2)n=h.pop(),s=h.pop(),"and"===l.value?h.push(!!s&&!!evaluate(n,e,r)):"or"===l.value?h.push(!!s||!!evaluate(n,e,r)):"="===l.value?(o=e.binaryOps[l.value],h.push(o(s,evaluate(n,e,r),r))):(o=e.binaryOps[l.value],h.push(o(resolveExpression(s,r),resolveExpression(n,r))));else if(f===IOP3)i=h.pop(),n=h.pop(),s=h.pop(),"?"===l.value?h.push(evaluate(s?n:i,e,r)):(o=e.ternaryOps[l.value],h.push(o(resolveExpression(s,r),resolveExpression(n,r),resolveExpression(i,r))));else if(f===IVAR)if(l.value in e.functions)h.push(e.functions[l.value]);else if(l.value in e.unaryOps&&e.parser.isOperatorEnabled(l.value))h.push(e.unaryOps[l.value]);else{var v=r[l.value];if(void 0===v)throw new Error("undefined variable: "+l.value);h.push(v)}else if(f===IOP1)s=h.pop(),o=e.unaryOps[l.value],h.push(o(resolveExpression(s,r)));else if(f===IFUNCALL){for(p=l.value,a=[];p-- >0;)a.unshift(resolveExpression(h.pop(),r));if(!(o=h.pop()).apply||!o.call)throw new Error(o+" is not a function");h.push(o.apply(void 0,a))}else if(f===IFUNDEF)h.push(function(){for(var t=h.pop(),s=[],n=l.value;n-- >0;)s.unshift(h.pop());var i=h.pop(),o=function(){for(var n=Object.assign({},r),i=0,o=s.length;i<o;i++)n[s[i]]=arguments[i];return evaluate(t,e,n)};return Object.defineProperty(o,"name",{value:i,writable:!1}),r[i]=o,o}());else if(f===IEXPR)h.push(createExpressionEvaluator(l,e));else if(f===IEXPREVAL)h.push(l);else if(f===IMEMBER)s=h.pop(),h.push(s[l.value]);else if(f===IENDSTATEMENT)h.pop();else{if(f!==IARRAY)throw new Error("invalid Expression");for(p=l.value,a=[];p-- >0;)a.unshift(h.pop());h.push(a)}}if(h.length>1)throw new Error("invalid Expression (parity)");return 0===h[0]?0:resolveExpression(h[0],r)}function createExpressionEvaluator(t,e,r){return isExpressionEvaluator(t)?t:{type:IEXPREVAL,value:function(r){return evaluate(t.value,e,r)}}}function isExpressionEvaluator(t){return t&&t.type===IEXPREVAL}function resolveExpression(t,e){return isExpressionEvaluator(t)?t.value(e):t}function expressionToString(t,e){for(var r,s,n,i,o,a,p=[],h=0;h<t.length;h++){var u=t[h],c=u.type;if(c===INUMBER)"number"==typeof u.value&&u.value<0?p.push("("+u.value+")"):Array.isArray(u.value)?p.push("["+u.value.map(escapeValue).join(", ")+"]"):p.push(escapeValue(u.value));else if(c===IOP2)s=p.pop(),r=p.pop(),i=u.value,e?"^"===i?p.push("Math.pow("+r+", "+s+")"):"and"===i?p.push("(!!"+r+" && !!"+s+")"):"or"===i?p.push("(!!"+r+" || !!"+s+")"):"||"===i?p.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):"=="===i?p.push("("+r+" === "+s+")"):"!="===i?p.push("("+r+" !== "+s+")"):"["===i?p.push(r+"[("+s+") | 0]"):p.push("("+r+" "+i+" "+s+")"):"["===i?p.push(r+"["+s+"]"):p.push("("+r+" "+i+" "+s+")");else if(c===IOP3){if(n=p.pop(),s=p.pop(),r=p.pop(),"?"!==(i=u.value))throw new Error("invalid Expression");p.push("("+r+" ? "+s+" : "+n+")")}else if(c===IVAR||c===IVARNAME)p.push(u.value);else if(c===IOP1)r=p.pop(),"-"===(i=u.value)||"+"===i?p.push("("+i+r+")"):e?"not"===i?p.push("(!"+r+")"):"!"===i?p.push("fac("+r+")"):p.push(i+"("+r+")"):"!"===i?p.push("("+r+"!)"):p.push("("+i+" "+r+")");else if(c===IFUNCALL){for(a=u.value,o=[];a-- >0;)o.unshift(p.pop());i=p.pop(),p.push(i+"("+o.join(", ")+")")}else if(c===IFUNDEF){for(s=p.pop(),a=u.value,o=[];a-- >0;)o.unshift(p.pop());r=p.pop(),e?p.push("("+r+" = function("+o.join(", ")+") { return "+s+" })"):p.push("("+r+"("+o.join(", ")+") = "+s+")")}else if(c===IMEMBER)r=p.pop(),p.push(r+"."+u.value);else if(c===IARRAY){for(a=u.value,o=[];a-- >0;)o.unshift(p.pop());p.push("["+o.join(", ")+"]")}else if(c===IEXPR)p.push("("+expressionToString(u.value,e)+")");else if(c!==IENDSTATEMENT)throw new Error("invalid Expression")}return p.length>1&&(p=e?[p.join(",")]:[p.join(";")]),String(p[0])}function escapeValue(t){return"string"==typeof t?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function contains(t,e){for(var r=0;r<t.length;r++)if(t[r]===e)return!0;return!1}function getSymbols(t,e,r){for(var s=!!(r=r||{}).withMembers,n=null,i=0;i<t.length;i++){var o=t[i];o.type===IVAR||o.type===IVARNAME?s||contains(e,o.value)?null!==n?(contains(e,n)||e.push(n),n=o.value):n=o.value:e.push(o.value):o.type===IMEMBER&&s&&null!==n?n+="."+o.value:o.type===IEXPR?getSymbols(o.value,e,r):null!==n&&(contains(e,n)||e.push(n),n=null)}null===n||contains(e,n)||e.push(n)}function Expression(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Instruction.prototype.toString=function(){switch(this.type){case INUMBER:case IOP1:case IOP2:case IOP3:case IVAR:case IVARNAME:case IENDSTATEMENT:return this.value;case IFUNCALL:return"CALL "+this.value;case IFUNDEF:return"DEF "+this.value;case IARRAY:return"ARRAY "+this.value;case IMEMBER:return"."+this.value;default:return"Invalid Instruction"}},Expression.prototype.simplify=function(t){return t=t||{},new Expression(simplify(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)},Expression.prototype.substitute=function(t,e){return e instanceof Expression||(e=this.parser.parse(String(e))),new Expression(substitute(this.tokens,t,e),this.parser)},Expression.prototype.evaluate=function(t){return t=t||{},evaluate(this.tokens,this,t)},Expression.prototype.toString=function(){return expressionToString(this.tokens,!1)},Expression.prototype.symbols=function(t){t=t||{};var e=[];return getSymbols(this.tokens,e,t),e},Expression.prototype.variables=function(t){t=t||{};var e=[];getSymbols(this.tokens,e,t);var r=this.functions;return e.filter((function(t){return!(t in r)}))},Expression.prototype.toJSFunction=function(t,e){var r=this,s=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+expressionToString(this.simplify(e).tokens,!0)+"; }");return function(){return s.apply(r,arguments)}};var TEOF="TEOF",TOP="TOP",TNUMBER="TNUMBER",TSTRING="TSTRING",TPAREN="TPAREN",TBRACKET="TBRACKET",TCOMMA="TCOMMA",TNAME="TNAME",TSEMICOLON="TSEMICOLON";function Token(t,e,r){this.type=t,this.value=e,this.index=r}function TokenStream(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}Token.prototype.toString=function(){return this.type+": "+this.value},TokenStream.prototype.newToken=function(t,e,r){return new Token(t,e,null!=r?r:this.pos)},TokenStream.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current},TokenStream.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent},TokenStream.prototype.next=function(){return this.pos>=this.expression.length?this.newToken(TEOF,"EOF"):this.isWhitespace()||this.isComment()?this.next():this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},TokenStream.prototype.isString=function(){var t=!1,e=this.pos,r=this.expression.charAt(e);if("'"===r||'"'===r)for(var s=this.expression.indexOf(r,e+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,"\\"!==this.expression.charAt(s-1)){var n=this.expression.substring(e+1,s);this.current=this.newToken(TSTRING,this.unescape(n),e),t=!0;break}s=this.expression.indexOf(r,s+1)}return t},TokenStream.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return("("===t||")"===t)&&(this.current=this.newToken(TPAREN,t),this.pos++,!0)},TokenStream.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return!("["!==t&&"]"!==t||!this.isOperatorEnabled("["))&&(this.current=this.newToken(TBRACKET,t),this.pos++,!0)},TokenStream.prototype.isComma=function(){return","===this.expression.charAt(this.pos)&&(this.current=this.newToken(TCOMMA,","),this.pos++,!0)},TokenStream.prototype.isSemicolon=function(){return";"===this.expression.charAt(this.pos)&&(this.current=this.newToken(TSEMICOLON,";"),this.pos++,!0)},TokenStream.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&"."!==r&&(r<"0"||r>"9")))break}if(e>t){var s=this.expression.substring(t,e);if(s in this.consts)return this.current=this.newToken(TNUMBER,this.consts[s]),this.pos+=s.length,!0}return!1},TokenStream.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&(r<"0"||r>"9")))break}if(e>t){var s=this.expression.substring(t,e);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(TOP,s),this.pos+=s.length,!0}return!1},TokenStream.prototype.isName=function(){for(var t=this.pos,e=t,r=!1;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()){if(e===this.pos&&("$"===s||"_"===s)){"_"===s&&(r=!0);continue}if(e===this.pos||!r||"_"!==s&&(s<"0"||s>"9"))break}else r=!0}if(r){var n=this.expression.substring(t,e);return this.current=this.newToken(TNAME,n),this.pos+=n.length,!0}return!1},TokenStream.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);!(" "!==e&&"\t"!==e&&"\n"!==e&&"\r"!==e||(t=!0,this.pos++,this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var codePointPattern=/^[0-9a-f]{4}$/i;function ParserState(t,e,r){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=!1!==r.allowMemberAccess}TokenStream.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var r=t.substring(0,e);e>=0;){var s=t.charAt(++e);switch(s){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+="\n";break;case"r":r+="\r";break;case"t":r+="\t";break;case"u":var n=t.substring(e+1,e+5);codePointPattern.test(n)||this.parseError("Illegal escape sequence: \\u"+n),r+=String.fromCharCode(parseInt(n,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++e;var i=t.indexOf("\\",e);r+=t.substring(e,i<0?t.length:i),e=i}return r},TokenStream.prototype.isComment=function(){return"/"===this.expression.charAt(this.pos)&&"*"===this.expression.charAt(this.pos+1)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)},TokenStream.prototype.isRadixInteger=function(){var t,e,r=this.pos;if(r>=this.expression.length-2||"0"!==this.expression.charAt(r))return!1;if(++r,"x"===this.expression.charAt(r))t=16,e=/^[0-9a-f]$/i,++r;else{if("b"!==this.expression.charAt(r))return!1;t=2,e=/^[01]$/i,++r}for(var s=!1,n=r;r<this.expression.length;){var i=this.expression.charAt(r);if(!e.test(i))break;r++,s=!0}return s&&(this.current=this.newToken(TNUMBER,parseInt(this.expression.substring(n,r),t)),this.pos=r),s},TokenStream.prototype.isNumber=function(){for(var t,e=!1,r=this.pos,s=r,n=r,i=!1,o=!1;r<this.expression.length&&((t=this.expression.charAt(r))>="0"&&t<="9"||!i&&"."===t);)"."===t?i=!0:o=!0,r++,e=o;if(e&&(n=r),"e"===t||"E"===t){r++;for(var a=!0,p=!1;r<this.expression.length;){if(t=this.expression.charAt(r),!a||"+"!==t&&"-"!==t){if(!(t>="0"&&t<="9"))break;p=!0,a=!1}else a=!1;r++}p||(r=n)}return e?(this.current=this.newToken(TNUMBER,parseFloat(this.expression.substring(s,r))),this.pos=r):this.pos=n,e},TokenStream.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if("+"===e||"-"===e||"*"===e||"/"===e||"%"===e||"^"===e||"?"===e||":"===e||"."===e)this.current=this.newToken(TOP,e);else if("∙"===e||"•"===e)this.current=this.newToken(TOP,"*");else if(">"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,">="),this.pos++):this.current=this.newToken(TOP,">");else if("<"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"<="),this.pos++):this.current=this.newToken(TOP,"<");else if("|"===e){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(TOP,"||"),this.pos++}else if("="===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"=="),this.pos++):this.current=this.newToken(TOP,e);else{if("!"!==e)return!1;"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"!="),this.pos++):this.current=this.newToken(TOP,e)}return this.pos++,!!this.isOperatorEnabled(this.current.value)||(this.pos=t,!1)},TokenStream.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)},TokenStream.prototype.getCoordinates=function(){var t,e=0,r=-1;do{e++,t=this.pos-r,r=this.expression.indexOf("\n",r+1)}while(r>=0&&r<this.pos);return{line:e,column:t}},TokenStream.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)},ParserState.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},ParserState.prototype.tokenMatches=function(t,e){return void 0===e||(Array.isArray(e)?contains(e,t.value):"function"==typeof e?e(t):t.value===e)},ParserState.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},ParserState.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},ParserState.prototype.accept=function(t,e){return!(this.nextToken.type!==t||!this.tokenMatches(this.nextToken,e))&&(this.next(),!0)},ParserState.prototype.expect=function(t,e){if(!this.accept(t,e)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(e||t))}},ParserState.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;if(this.accept(TNAME)||this.accept(TOP,(function(t){return t.value in e})))t.push(new Instruction(IVAR,this.current.value));else if(this.accept(TNUMBER))t.push(new Instruction(INUMBER,this.current.value));else if(this.accept(TSTRING))t.push(new Instruction(INUMBER,this.current.value));else if(this.accept(TPAREN,"("))this.parseExpression(t),this.expect(TPAREN,")");else{if(!this.accept(TBRACKET,"["))throw new Error("unexpected "+this.nextToken);if(this.accept(TBRACKET,"]"))t.push(new Instruction(IARRAY,0));else{var r=this.parseArrayList(t);t.push(new Instruction(IARRAY,r))}}},ParserState.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),this.parseUntilEndStatement(t,e)||this.pushExpression(t,e))},ParserState.prototype.pushExpression=function(t,e){for(var r=0,s=e.length;r<s;r++)t.push(e[r])},ParserState.prototype.parseUntilEndStatement=function(t,e){return!!this.accept(TSEMICOLON)&&(!this.nextToken||this.nextToken.type===TEOF||this.nextToken.type===TPAREN&&")"===this.nextToken.value||e.push(new Instruction(IENDSTATEMENT)),this.nextToken.type!==TEOF&&this.parseExpression(e),t.push(new Instruction(IEXPR,e)),!0)},ParserState.prototype.parseArrayList=function(t){for(var e=0;!this.accept(TBRACKET,"]");)for(this.parseExpression(t),++e;this.accept(TCOMMA);)this.parseExpression(t),++e;return e},ParserState.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(TOP,"=");){var e=t.pop(),r=[],s=t.length-1;if(e.type!==IFUNCALL){if(e.type!==IVAR&&e.type!==IMEMBER)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),t.push(new Instruction(IVARNAME,e.value)),t.push(new Instruction(IEXPR,r)),t.push(binaryInstruction("="))}else{if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var n=0,i=e.value+1;n<i;n++){var o=s-n;t[o].type===IVAR&&(t[o]=new Instruction(IVARNAME,t[o].value))}this.parseVariableAssignmentExpression(r),t.push(new Instruction(IEXPR,r)),t.push(new Instruction(IFUNDEF,e.value))}}},ParserState.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(TOP,"?");){var e=[],r=[];this.parseConditionalExpression(e),this.expect(TOP,":"),this.parseConditionalExpression(r),t.push(new Instruction(IEXPR,e)),t.push(new Instruction(IEXPR,r)),t.push(ternaryInstruction("?"))}},ParserState.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(TOP,"or");){var e=[];this.parseAndExpression(e),t.push(new Instruction(IEXPR,e)),t.push(binaryInstruction("or"))}},ParserState.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(TOP,"and");){var e=[];this.parseComparison(e),t.push(new Instruction(IEXPR,e)),t.push(binaryInstruction("and"))}};var COMPARISON_OPERATORS=["==","!=","<","<=",">=",">","in"];ParserState.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(TOP,COMPARISON_OPERATORS);){var e=this.current;this.parseAddSub(t),t.push(binaryInstruction(e.value))}};var ADD_SUB_OPERATORS=["+","-","||"];ParserState.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(TOP,ADD_SUB_OPERATORS);){var e=this.current;this.parseTerm(t),t.push(binaryInstruction(e.value))}};var TERM_OPERATORS=["*","/","%"];function add(t,e){return Number(t)+Number(e)}function sub(t,e){return t-e}function mul(t,e){return t*e}function div(t,e){return t/e}function mod(t,e){return t%e}function concat(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function equal(t,e){return t===e}function notEqual(t,e){return t!==e}function greaterThan(t,e){return t>e}function lessThan(t,e){return t<e}function greaterThanEqual(t,e){return t>=e}function lessThanEqual(t,e){return t<=e}function andOperator(t,e){return Boolean(t&&e)}function orOperator(t,e){return Boolean(t||e)}function inOperator(t,e){return contains(e,t)}function sinh(t){return(Math.exp(t)-Math.exp(-t))/2}function cosh(t){return(Math.exp(t)+Math.exp(-t))/2}function tanh(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function asinh(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function acosh(t){return Math.log(t+Math.sqrt(t*t-1))}function atanh(t){return Math.log((1+t)/(1-t))/2}function log10(t){return Math.log(t)*Math.LOG10E}function neg(t){return-t}function not(t){return!t}function trunc(t){return t<0?Math.ceil(t):Math.floor(t)}function random(t){return Math.random()*(t||1)}function factorial(t){return gamma(t+1)}function isInteger(t){return isFinite(t)&&t===Math.round(t)}ParserState.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(TOP,TERM_OPERATORS);){var e=this.current;this.parseFactor(t),t.push(binaryInstruction(e.value))}},ParserState.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;if(this.save(),this.accept(TOP,(function(t){return t.value in e}))){if("-"!==this.current.value&&"+"!==this.current.value){if(this.nextToken.type===TPAREN&&"("===this.nextToken.value)return this.restore(),void this.parseExponential(t);if(this.nextToken.type===TSEMICOLON||this.nextToken.type===TCOMMA||this.nextToken.type===TEOF||this.nextToken.type===TPAREN&&")"===this.nextToken.value)return this.restore(),void this.parseAtom(t)}var r=this.current;this.parseFactor(t),t.push(unaryInstruction(r.value))}else this.parseExponential(t)},ParserState.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(TOP,"^");)this.parseFactor(t),t.push(binaryInstruction("^"))},ParserState.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(TOP,"!");)t.push(unaryInstruction("!"))},ParserState.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;if(this.accept(TOP,(function(t){return t.value in e}))){var r=this.current;this.parseAtom(t),t.push(unaryInstruction(r.value))}else for(this.parseMemberExpression(t);this.accept(TPAREN,"(");)if(this.accept(TPAREN,")"))t.push(new Instruction(IFUNCALL,0));else{var s=this.parseArgumentList(t);t.push(new Instruction(IFUNCALL,s))}},ParserState.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(TPAREN,")");)for(this.parseExpression(t),++e;this.accept(TCOMMA);)this.parseExpression(t),++e;return e},ParserState.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(TOP,".")||this.accept(TBRACKET,"[");){var e=this.current;if("."===e.value){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(TNAME),t.push(new Instruction(IMEMBER,this.current.value))}else{if("["!==e.value)throw new Error("unexpected symbol: "+e.value);if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(TBRACKET,"]"),t.push(binaryInstruction("["))}}};var GAMMA_G=4.7421875,GAMMA_P=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function gamma(t){var e,r;if(isInteger(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var s=t-2,n=t-1;s>1;)n*=s,s--;return 0===n&&(n=1),n}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*gamma(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,o=i*t,a=o*t,p=a*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*o)-571/(2488320*a)+163879/(209018880*p)+5246819/(75246796800*p*t))}--t,r=GAMMA_P[0];for(var h=1;h<GAMMA_P.length;++h)r+=GAMMA_P[h]/(t+h);return e=t+GAMMA_G+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*r}function stringOrArrayLength(t){return Array.isArray(t)?t.length:String(t).length}function hypot(){for(var t=0,e=0,r=0;r<arguments.length;r++){var s,n=Math.abs(arguments[r]);e<n?(t=t*(s=e/n)*s+1,e=n):t+=n>0?(s=n/e)*s:n}return e===1/0?1/0:e*Math.sqrt(t)}function condition(t,e,r){return t?e:r}function roundTo(t,e){return void 0===e||0==+e?Math.round(t):(t=+t,e=-+e,isNaN(t)||"number"!=typeof e||e%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+e:e))))}function setVar(t,e,r){return r&&(r[t]=e),e}function arrayIndex(t,e){return t[0|e]}function max(t){return 1===arguments.length&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function min(t){return 1===arguments.length&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function arrayMap(t,e){if("function"!=typeof t)throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map((function(e,r){return t(e,r)}))}function arrayFold(t,e,r){if("function"!=typeof t)throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce((function(e,r,s){return t(e,r,s)}),e)}function arrayFilter(t,e){if("function"!=typeof t)throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter((function(e,r){return t(e,r)}))}function stringOrArrayIndexOf(t,e){if(!Array.isArray(e)&&"string"!=typeof e)throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function arrayJoin(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function sign(t){return(t>0)-(t<0)||+t}var ONE_THIRD=1/3;function cbrt(t){return t<0?-Math.pow(-t,ONE_THIRD):Math.pow(t,ONE_THIRD)}function expm1(t){return Math.exp(t)-1}function log1p(t){return Math.log(1+t)}function log2(t){return Math.log(t)/Math.LN2}function Parser(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||sinh,cosh:Math.cosh||cosh,tanh:Math.tanh||tanh,asinh:Math.asinh||asinh,acosh:Math.acosh||acosh,atanh:Math.atanh||atanh,sqrt:Math.sqrt,cbrt:Math.cbrt||cbrt,log:Math.log,log2:Math.log2||log2,ln:Math.log,lg:Math.log10||log10,log10:Math.log10||log10,expm1:Math.expm1||expm1,log1p:Math.log1p||log1p,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||trunc,"-":neg,"+":Number,exp:Math.exp,not:not,length:stringOrArrayLength,"!":factorial,sign:Math.sign||sign},this.binaryOps={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,"||":concat,"==":equal,"!=":notEqual,">":greaterThan,"<":lessThan,">=":greaterThanEqual,"<=":lessThanEqual,and:andOperator,or:orOperator,in:inOperator,"=":setVar,"[":arrayIndex},this.ternaryOps={"?":condition},this.functions={random:random,fac:factorial,min:min,max:max,hypot:Math.hypot||hypot,pyt:Math.hypot||hypot,pow:Math.pow,atan2:Math.atan2,if:condition,gamma:gamma,roundTo:roundTo,map:arrayMap,fold:arrayFold,filter:arrayFilter,indexOf:stringOrArrayIndexOf,join:arrayJoin},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Parser.prototype.parse=function(t){var e=[],r=new ParserState(this,new TokenStream(this,t),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(e),r.expect(TEOF,"EOF"),new Expression(e,this)},Parser.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var sharedParser=new Parser;Parser.parse=function(t){return sharedParser.parse(t)},Parser.evaluate=function(t,e){return sharedParser.parse(t).evaluate(e)};var optionNameMap={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function getOptionName(t){return optionNameMap.hasOwnProperty(t)?optionNameMap[t]:t}Parser.prototype.isOperatorEnabled=function(t){var e=getOptionName(t),r=this.options.operators||{};return!(e in r)||!!r[e]};var index={Parser:Parser,Expression:Expression};